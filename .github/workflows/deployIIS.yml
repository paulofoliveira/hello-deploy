name: 'Deploy on IIS'
on:
    push:
        branches: [ main ]
        paths:
            - 'src/HelloDeploy.Web/**'

    workflow_dispatch: # Allow you to run this workflow manually from the Action tab

env:
    PACKAGE_OUTPUT_DIRECTORY: ${{ github.workspace }}/src/HelloDeploy.Web/output
    SOLUTION_NAME: 'HelloDeploy.sln'
    BUILD_PLATFORM: 'Any CPU'
    BUILD_CONFIGURATION: 'Release'
    PACKAGE_NAME: 'webapp'
    
jobs:
    build-and-package:
        name: 'Build and Package'
        runs-on: windows-latest
        steps:
            - name: 'Checkout'
              uses: actions/checkout@v3
              with:
                fetch-depth: 0
            
            - name: 'Setup MSBuild'
              uses: microsoft/setup-msbuild@v1.1

            - name: 'Setup Nuget Package Restore'
              uses: nuget/setup-nuget@v1

            - name: 'Restore Nuget Packages'
              run: nuget restore ${{ env.SOLUTION_NAME }}

            - name: 'Build Application'
              run: |
                msbuild ${{ env.SOLUTION_NAME }} /p:Platform="${{ env.BUILD_PLATFORM }}" /p:Configuration="${{ env.BUILD_CONFIGURATION }}" /p:DeployIISAppPath="${{ secrets.WEBDEPLOY_SITENAME }}" /p:DeployOnBuild=true /p:WebPublishMethod=Package /p:PackageAsSingleFile=true /p:SkipInvalidConfigurations=true /p:PackageLocation="${{ env.PACKAGE_OUTPUT_DIRECTORY }}" /p:AllowUntrustedCertificate=true /p:PrecompileBeforePublish=true

            - name: 'Upload Package'
              uses: actions/upload-artifact@v3
              with:
                name: ${{ env.PACKAGE_NAME }}
                path: ${{ env.PACKAGE_OUTPUT_DIRECTORY }}
    
    deploy:
      name: 'Deploy on IIS'
      needs: 'build-and-package'
      runs-on: windows-latest
      steps:     
          
            - name: 'Download Package'
              uses: actions/download-artifact@v3
              with:
                name: ${{ env.PACKAGE_NAME }}

            - name: 'Deploy with MsDeploy'
              run: '& "C:/Program Files/IIS/Microsoft Web Deploy V3/msdeploy.exe" -verb:sync -source:package=HelloDeploy.Web.zip -allowUntrusted -dest:auto,computerName="https://${{ secrets.WEBDEPLOY_HOST }}/msdeploy.axd?site=${{ secrets.WEBDEPLOY_SITENAME }}",username="${{ secrets.WEBDEPLOY_USERNAME }}",password="${{ secrets.WEBDEPLOY_PASSWD }}",AuthType="Basic" -verbose -enableRule:DoNotDeleteRule'

            - name: 'Delete Package'
              uses: geekyggo/delete-artifact@v2
              with:
                name: ${{ env.PACKAGE_NAME }}
